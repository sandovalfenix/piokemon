# Implementation Plan: Battle Module Update

**Branch**: `006-battle-module-update` | **Date**: 2025-12-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/006-battle-module-update/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command.

## Summary

Update the Battle Module to implement: (1) Turn-based combat with dynamic level scaling (Opponent Level - 2), excluding Status moves and all Item usage; (2) Linear progression through 5 Cali-themed Gym Leaders with Thematic NPC prerequisites; (3) Victory outcomes with auto-heal and Move Learning UI (4-move limit); (4) Defeat Modal using shadcn-vue Dialog; (5) Wild Encounters for combat practice; (6) Persistent progress via Pinia/LocalStorage.

Technical approach: Extend existing battle store and domain logic, create new progress store, integrate with existing team store, add UI components using shadcn-vue primitives.

## Technical Context

**Language/Version**: TypeScript 5.9+ (strict mode)  
**Primary Dependencies**: Vue 3.5+ (Composition API), Pinia 3+, Vue Router 4+, shadcn-vue (Radix Vue), Tailwind CSS 3+  
**Storage**: LocalStorage (browser) via Pinia store synchronization  
**Testing**: Vitest (unit/integration tests in `tests/` directory)  
**Target Platform**: Web browser (desktop/mobile responsive, PWA-ready)
**Project Type**: Single-page web application (Vue 3 SPA)  
**Performance Goals**: Battle turn resolution <200ms, state transitions <200ms, 60fps animations  
**Constraints**: Offline-capable with LocalStorage, <100KB additional bundle size  
**Scale/Scope**: Single-player game, 5 gyms, ~30 Thematic NPCs, Gen 1 Pokémon pool (151)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Requirement | Status | Notes |
|-----------|-------------|--------|-------|
| **I. Component Architecture** | Vue 3 Composition API, `<script setup>` | ✅ PASS | All new components will use `<script setup lang="ts">` |
| **II. TypeScript Discipline** | Strict mode, no `any`, define interfaces | ✅ PASS | All entities defined in spec have clear interfaces |
| **III. State Management** | Pinia with Option Stores, clear state/getters/actions | ✅ PASS | Progress store + battle store extensions |
| **IV. Testing & Reliability** | Vitest, pure functions, seeded RNG | ✅ PASS | Level scaling, damage calc testable as pure functions |
| **V. Performance** | <200ms p95, memoized computed, lazy loading | ✅ PASS | State transitions <200ms per SC-014 |
| **VI. Quality Enforcement** | type-check, lint, tests pass | ✅ PASS | Standard CI gates apply |
| **VII. PokeAPI** | Single source of truth for Pokémon data | ✅ PASS | Existing infrastructure in services/teamBuilder |
| **VIII. shadcn-vue** | ALL UI components MUST use shadcn-vue | ✅ PASS | Defeat Modal (Dialog), Move Learning (Dialog + Button), Wild Battle (Button) |

**Gate Result**: ✅ PASSED - No violations. Proceed to Phase 0.

**Constitution Alignment Notes**:
- FR-019 (Defeat Modal) explicitly requires Shadcn Dialog → aligns with Principle VIII
- FR-017/FR-018 (Move Learning UI) will use Shadcn Dialog + Select + Button
- All state persistence uses Pinia → aligns with Principle III
- Level scaling and damage calculation are pure functions → aligns with Principle IV testing

## Project Structure

### Documentation (this feature)

```text
specs/006-battle-module-update/
├── plan.md              # This file
├── research.md          # Phase 0 output - research findings
├── data-model.md        # Phase 1 output - entity definitions
├── quickstart.md        # Phase 1 output - dev setup guide
├── contracts/           # Phase 1 output - API contracts
│   ├── progress-state.ts
│   ├── battle-outcomes.ts
│   └── move-learning.ts
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)

```text
src/
├── components/
│   ├── battle/                    # Battle UI components
│   │   ├── DefeatModal.vue        # NEW: Shadcn Dialog for defeat outcome
│   │   ├── MoveLearningModal.vue  # NEW: Move replacement UI
│   │   └── WildBattleButton.vue   # NEW: Lobby wild encounter trigger
│   └── ui/                        # Shadcn-vue components (existing)
├── composables/
│   ├── useBattleLoop.ts           # MODIFY: Add level scaling, status move filter
│   └── useTrainerBattle.ts        # MODIFY: Integrate with progression
├── data/
│   ├── gymLeaders.ts              # EXISTING: Cali gym leader data (updated)
│   ├── trainersData.ts            # MODIFY: Add Thematic NPCs per gym
│   └── moves.ts                   # EXISTING: Move database
├── domain/
│   └── battle/                    # Battle engine (existing structure)
│       ├── calc/                  # Damage, type chart calculations
│       └── engine/                # Battle state machine
├── models/
│   ├── progressState.ts           # NEW: Progress persistence interfaces
│   └── battleOutcome.ts           # NEW: Victory/defeat outcome types
├── services/
│   ├── battle/                    # MODIFY: Add outcome handlers
│   └── progress/                  # NEW: Progress persistence service
│       └── progressService.ts
├── stores/
│   ├── battle.ts                  # MODIFY: Add outcome handling, level scaling
│   ├── team.ts                    # EXISTING: Team management
│   └── progress.ts                # NEW: Story progression store
└── views/
    ├── BattleView.vue             # MODIFY: Integrate modals, outcomes
    └── HomeView.vue               # MODIFY: Add wild battle button, progression UI

tests/
├── unit/
│   └── domain/
│       └── battle/
│           ├── levelScaling.spec.ts     # NEW: Test dynamic level formula
│           └── statusMoveFilter.spec.ts # NEW: Test status move exclusion
└── integration/
    └── components/
        └── progressFlow.spec.ts   # NEW: Test linear progression
```

**Structure Decision**: Vue 3 SPA single-project structure. Battle domain logic already exists in `src/domain/battle/`. New components follow existing patterns in `src/components/battle/`. New progress store follows existing store patterns. All modifications integrate with existing architecture.

## Complexity Tracking

> **No violations detected** - Constitution Check passed. No complexity justifications required.

---

## Post-Design Constitution Re-Check

*After Phase 1 design completion (data-model.md, contracts/, quickstart.md)*

| Principle | Re-Check | Status | Design Artifacts |
|-----------|----------|--------|------------------|
| **I. Component Architecture** | All Vue components use `<script setup lang="ts">` | ✅ PASS | DefeatModal.vue, MoveLearningModal.vue, WildBattleButton.vue |
| **II. TypeScript Discipline** | All interfaces defined, no `any` types | ✅ PASS | contracts/*.ts, data-model.md entities |
| **III. State Management** | Pinia stores with typed state | ✅ PASS | progress.ts store, progress-state.ts contract |
| **IV. Testing & Reliability** | Pure functions identified for testing | ✅ PASS | calculateScaledLevel, applyMoveLearning, status filter |
| **V. Performance** | <200ms constraints documented | ✅ PASS | SC-014 in spec, Technical Context |
| **VI. Quality Enforcement** | Test files planned | ✅ PASS | quickstart.md testing section |
| **VII. PokeAPI** | Existing PokeAPI integration preserved | ✅ PASS | Wild pool uses PokeAPI IDs |
| **VIII. shadcn-vue** | Dialog, Button, Select components specified | ✅ PASS | All modals use shadcn-vue Dialog |

**Post-Design Gate Result**: ✅ PASSED - Design aligns with constitution principles.

---

## Phase Completion Summary

| Phase | Status | Artifacts |
|-------|--------|-----------|
| **Phase 0: Research** | ✅ Complete | `research.md` |
| **Phase 1: Design** | ✅ Complete | `data-model.md`, `contracts/`, `quickstart.md` |
| **Phase 2: Tasks** | ✅ Complete | `tasks.md` (62 tasks across 9 phases) |

**Next Step**: Begin implementation with Phase 1 Setup tasks (T001-T006).

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
